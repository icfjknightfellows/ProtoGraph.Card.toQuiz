<!DOCTYPE html>
<html>
  <head>
    <meta charset = "UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>toQuiz Card</title>
    <link rel="stylesheet" type="text/css" href="https://dwln9tzsi7g07.cloudfront.net/Assets/semantic.min.css" media="screen">
    <link rel="stylesheet" type="text/css" href="card.min.css" media="screen">
    <script type="text/javascript">
     var siteId, origin, base_url;
     // Setting variables from environment
     origin = window.location.origin;
     if (origin == 'https://s3.ap-south-1.amazonaws.com') {
       let bucket_name = window.location.pathname.split('/')['1'];
       base_url = origin + "/" + bucket_name;
       switch(bucket_name){
         case "cdn.protograph":
           siteId = '1';
           break;
         case "staging.cdn.protograph":
           siteId = '2';
           break;
       }
     } else if (origin === 'https://dkqrqc7q64awx.cloudfront.net') {
       siteId = '2';
       base_url = origin;
     } else {
       siteId = '1';
       base_url = origin;
     }
     // Uncomment below lines for use in production
     /* siteId = 2;
      * base_url = "https://dnt71st2q6cqr.cloudfront.net"*/
     
     if(siteId){
       var _paq = _paq || [];
       /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
       _paq.push(['trackPageView']);
       _paq.push(['enableLinkTracking']);
       (function() {
         var u="//protograph.innocraft.cloud/";
         _paq.push(['setTrackerUrl', u+'piwik.php']);
         _paq.push(['setSiteId', siteId]);
         var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
         g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
       })();
     }
    </script>
    <style type="text/css">
     body {
       margin: 0px !important;
     }
    </style>
  </head>
  <body>
    <div id="protograph_toQuiz_root"></div>
    <script src="https://dwln9tzsi7g07.cloudfront.net/lib/protograph-core.min.js"></script>
    <script src = "./card.min.js"></script>
    <script type="text/javascript">
     var x = new ProtoGraph.Card.toQuiz();
     function findGetParameter(parameterName) {
       var result = null,
           tmp = [],
           search_url = decodeURIComponent(location.search);

       search_url
         .substr(1)
         .split("&")
         .forEach(function (item) {
           tmp = item.split("=");
           if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
         });
       return result;
     }

     let view_cast_id = findGetParameter('view_cast_id'),
         schema_id = findGetParameter('schema_id'),
         mode = findGetParameter('mode');


     var ReceiverConsumer = Oasis.Consumer.extend({
       requests: {
         receive: function(mode) {
           var that = this;
           if(typeof (view_cast_id) !== 'undefined' && typeof(schema_id) !== 'undefined'){
             var that = this,
                 data_base_path = base_url + "/" + view_cast_id,
                 schema_base_path = base_url + "/" + schema_id;

             let options = {
               viewCastId: view_cast_id,
               selector: document.querySelector('#protograph_toQuiz_root'),
               data_url: data_base_path + "/data.json",
               schema_url: schema_base_path + "/schema.json",
               configuration_url: data_base_path + "/view_cast.json",
               configuration_schema_url: 'configuration_schema.json',
               // configuration_url: './configuration_sample.json', //will come from local folder
               ui_schema_url: './dist/0.0.1/ui_schema.json',
               base_url: "http://localhost:8080/",
               piwikCallback: function (category, action, name) {
                 _paq.push(['trackEvent', category, action, name]);
               },
               onClickCallback: function () {
                 let h = x.getData().height,
                     w = x.getData().width;
                 that.send('resize_frame', {width: w, height: h})
               }
             };

             options.base_url = window.location.href.split("/index.html")[0];
             x.init(options);
             renderWithMode(mode);
           }
         }
       },
       events: {
         get_size: function(){
           var that = this;
           var intervalId = setInterval(function(){
             console.log(that, document.querySelector('#protograph_toQuiz'), "that in get size")
             clientRect = x.getData();
             if(clientRect.height){
               var height = clientRect.height,
                   width = clientRect.width;
               that.send("resize_frame", {height: height, width: width});
               clearInterval(intervalId);
             }
           }, 1000)
         },
         change_mode: function(mode){
           renderWithMode(mode);
           var that = this;
           setTimeout(function(){
             height = x.getData().height;
             that.send("resize_frame", {height: height});
           })
         }
       }
     });
     oasis.connect({
       consumers: {
         receive: ReceiverConsumer
       }
     });

     function renderWithMode(mode) {
       switch(mode){
         case "laptop":
           x.renderLaptop();
           break;
         case "mobile":
           x.renderMobile();
           break;
       }
     }

    </script>
  </body>
</html>
